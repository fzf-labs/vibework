## Context

任务详情页现有 Git diff 视图功能残缺、样式粗糙，且渲染逻辑零散，难以维护与复用。项目内已有 Git 相关能力与 IPC API，可获取文件变更与 diff 数据；另有 demo 实现（/Users/fuzhifei/code/go/src/demo/1code）可作为 UI/交互参考。

## Goals / Non-Goals

**Goals:**
- 将 Git diff 渲染抽离为独立组件，供任务详情页与未来其他视图复用。
- 提升 diff 视图可读性（文件头信息、行号、变更标记、语法高亮）。
- 保持数据来源与现有 Git IPC/状态流兼容，避免大范围改动。

**Non-Goals:**
- 不新增 Git 能力（如 rebase、merge、提交等高级操作）。
- 不改变后端/IPC 协议的结构，仅做前端整合与呈现优化。
- 不在本次范围内重做任务详情页的整体布局。

## Decisions

1. **抽离独立 Git diff 组件**
   - 选择将 diff 视图封装为可复用组件（包含文件列表、diff 渲染与高亮）。
   - 好处：统一渲染逻辑、样式与交互，便于后续复用与测试。
   - 备选方案：继续在任务详情页内内联实现。否决原因：难维护、难复用。

2. **采用 git-diff-view 系列组件**
   - 使用 `@git-diff-view/react` 提供的渲染能力，并配合 `@git-diff-view/file` 与 `@git-diff-view/shiki` 进行文件模型与高亮整合。
   - 好处：减少自研 diff 解析与渲染工作，保持一致的 UI 表达。
   - 备选方案：自研 diff 解析与渲染。否决原因：成本高且易产生视觉与性能问题。

3. **对齐 demo 实现的视觉与信息结构**
   - 参考 demo 的布局（文件头、路径、变更统计、行号/标记）并适配现有任务详情页容器。
   - 备选方案：仅做最小 UI 修复。否决原因：无法解决“丑陋且不完整”的核心问题。

## Risks / Trade-offs

- **[渲染性能]** 大文件 diff 渲染可能导致卡顿 → 采用按文件分段渲染与虚拟滚动（如可行）或折叠大文件默认关闭。
- **[依赖兼容]** 新增 git-diff-view 相关包版本不一致 → 明确版本锁定与最小可用集成。
- **[样式冲突]** 新组件样式与现有主题不一致 → 使用局部样式隔离并对齐现有主题变量。

## Migration Plan

1. 引入新组件与相关依赖，完成最小渲染能力。
2. 在任务详情页中替换现有 diff 视图实现。
3. 回归测试 Git 相关场景（有变更/无变更/非 Git 目录）。
4. 如出现重大问题，可切回旧 diff 视图实现。

## Open Questions

- 是否需要在 diff 视图中支持文件级筛选/搜索？
- 组件是否需要暴露“单文件渲染模式”供其他页面使用？
